<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>5-Day Workout + Mobility Tracker</title>
<link rel="icon" href="icon.svg" type="image/svg+xml">
<style>
:root{
  --bg:#0b1220;
  --card:#0f1a33;
  --card2:#0c152b;
  --line:rgba(255,255,255,.12);
  --text:#eaf0ff;
  --muted:#9bb0d6;
  --accent:#7aa2ff;
  --good:#35d07f;
  --bad:#ff6b6b;
  --shadow:0 12px 40px rgba(0,0,0,.35);
  --r:18px;
  --sat: env(safe-area-inset-top);
  --sans:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  --header-bg:rgba(11,18,32,.85);
  --card-bg:rgba(15,26,51,.72);
  --menu-bg:#0f1a33;
  --btn-bg:rgba(15,26,51,.78);
  --ui-bg:rgba(12,21,43,.55);
  --input-bg:rgba(12,21,43,.80);
  --badge-bg:rgba(12,21,43,.62);
}
body.light{
  --bg:#f2f4f7;
  --card:#ffffff;
  --card2:#f8f9fa;
  --line:rgba(0,0,0,.1);
  --text:#1a202c;
  --muted:#718096;
  --accent:#3182ce;
  --good:#38a169;
  --bad:#e53e3e;
  --shadow:0 4px 12px rgba(0,0,0,.08);
  --header-bg:rgba(255,255,255,.95);
  --card-bg:#ffffff;
  --menu-bg:#ffffff;
  --btn-bg:#ffffff;
  --ui-bg:#f1f5f9;
  --input-bg:#ffffff;
  --badge-bg:#e2e8f0;
}
body.light{
  background: radial-gradient(900px 600px at 18% 12%, rgba(49,130,206,.15), transparent 60%),
              radial-gradient(900px 600px at 86% 26%, rgba(56,161,105,.10), transparent 60%), var(--bg);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:var(--sans); color:var(--text); background:
    radial-gradient(900px 600px at 18% 12%, rgba(122,162,255,.20), transparent 60%),
    radial-gradient(900px 600px at 86% 26%, rgba(53,208,127,.14), transparent 60%),
    radial-gradient(900px 700px at 50% 110%, rgba(255,204,102,.10), transparent 60%),
    var(--bg);
  touch-action: manipulation;
  padding-top: 0;
}
header{
  position:relative;
  z-index:120;
  backdrop-filter: blur(10px);
  background: var(--header-bg);
  border-bottom:1px solid var(--line);
  padding-top: var(--sat);
}
.wrap{max-width:820px; margin:0 auto; padding:12px 14px;}
.head{display:flex; gap:10px; align-items:flex-start; justify-content:space-between;}
h1{margin:0; font-size:16px; font-weight:850; letter-spacing:.2px}
.sub{margin-top:3px; font-size:12px; color:var(--muted)}
.btn{
  border:1px solid var(--line); background:var(--btn-bg); color:var(--text);
  border-radius:12px; padding:10px 12px; font-weight:800; font-size:13px; cursor:pointer;
  box-shadow:0 10px 28px rgba(0,0,0,.18);
}
.btn.primary{border-color:rgba(122,162,255,.55); background:rgba(122,162,255,.16)}
.btn.good{border-color:rgba(53,208,127,.45); background:rgba(53,208,127,.14)}
.btn.bad{border-color:rgba(255,107,107,.45); background:rgba(255,107,107,.14)}
main{max-width:820px; margin:0 auto; padding:14px 14px 88px;}
.card{
  background:var(--card-bg); border:1px solid var(--line); border-radius:22px;
  box-shadow:var(--shadow); overflow:hidden; margin-bottom:12px;
}
.ch{padding:14px 14px; border-bottom:1px solid rgba(255,255,255,.22); display:flex; justify-content:space-between; align-items:center; gap:10px;}
.ch h2{margin:0; font-size:14px; letter-spacing:.2px}
.cb{padding:14px 14px}
.badge{
  font-size:12px; padding:6px 10px; border-radius:999px;
  border:1px solid var(--line); background:var(--badge-bg); color:var(--muted);
  font-variant-numeric: tabular-nums;
}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.small{font-size:12px; color:var(--muted); line-height:1.45}
.hr{height:1px; background:var(--line); margin:12px 0}
.checkbox{
  display:flex; align-items:flex-start; gap:10px;
  padding:10px 10px; border-radius:14px;
  border:1px solid var(--line); background:var(--ui-bg);
  margin-bottom:10px;
}
.checkbox input{margin-top:3px}
.checkbox .t{
  font-weight:850; font-size:13px; line-height:1.25;
  margin-bottom:4px;
}
.checkbox .d{font-size:12px; color:var(--muted); margin-top:3px; line-height:1.35}
details{
  border:1px solid var(--line); background:var(--ui-bg);
  border-radius:16px; overflow:hidden; margin-bottom:10px;
}
summary{
  list-style:none; cursor:pointer; user-select:none;
  padding:12px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px;
  font-weight:900; font-size:13px;
}
summary::-webkit-details-marker{display:none}
.details-body{padding:0 12px 12px; border-top:1px solid var(--line)}
.pill{
  display:inline-flex; gap:8px; align-items:center;
  border:1px solid var(--line); background:var(--ui-bg);
  border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted);
  margin-right:8px; margin-top:8px;
}
.pill b{color:var(--text); font-weight:900}
.optionToggle{
  display:inline-flex;
  gap:4px;
  align-items:center;
  padding:4px;
  border-radius:999px;
  border:1px solid var(--line);
  background:var(--ui-bg);
  margin-top:8px;
}
.optBtn{
  border:0;
  background:transparent;
  color:var(--muted);
  font-weight:900;
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
}
.optBtn.active{
  color:var(--text);
  background:rgba(122,162,255,.22);
  border:1px solid rgba(122,162,255,.55);
}
.table{
  margin-top:10px;
  display:grid;
  grid-template-columns: 56px 1fr 1fr 1fr 74px;
  gap:8px;
  align-items:center;
}
.th{
  font-size:11px; color:var(--muted); padding:0 2px;
}
.cell input{
  width:100%;
  padding:10px 10px;
  border-radius:12px;
  border:1px solid var(--line);
  background:var(--input-bg);
  color:var(--text);
  font-size:13px;
}
.setnum{
  font-family:var(--mono);
  color:var(--muted);
  font-size:12px;
  padding-left:2px;
}
.done{
  display:flex; justify-content:center;
}
.footerTabs{
  position:fixed; bottom:0; left:0; right:0; z-index:20;
  background:var(--header-bg);
  border-top:1px solid var(--line);
  backdrop-filter: blur(10px);
}
.footerInner{
  max-width:820px; margin:0 auto; padding:10px 10px;
  display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; align-items:center;
}
.tabs{display:flex; gap:8px; flex-wrap:wrap}
.tab{
  padding:10px 12px; border-radius:999px;
  border:1px solid var(--line); background:var(--btn-bg);
  color:var(--muted); font-weight:900; font-size:12px; cursor:pointer;
}
.tab.active{border-color:rgba(122,162,255,.55); background:rgba(122,162,255,.16); color:var(--text)}
.kpi{display:flex; gap:8px; align-items:center}
.kpi .mono{font-family:var(--mono)}
.timerGrid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap:12px;
}
.timerBox{
  border:1px solid var(--line);
  background:var(--ui-bg);
  border-radius:16px;
  padding:12px;
}
.restPopup{
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%, -50%);
  background:linear-gradient(135deg, rgba(20,30,58,.98), rgba(36,50,90,.98));
  border:1px solid rgba(122,162,255,.6);
  border-radius:18px;
  box-shadow:0 18px 50px rgba(0,0,0,.45), 0 0 18px rgba(122,162,255,.25);
  padding:14px;
  width:min(92vw, 420px);
  z-index:50;
}
.restPopup .small{color:var(--muted)}
.restPopup .badge{color:var(--muted)}
.restPopup .btn{background:var(--btn-bg)}
.restPopup .btn.bad{border-color:rgba(255,107,107,.45)}
.restPopup .btn.good{border-color:rgba(53,208,127,.45)}
.restOverlay{
  position:fixed;
  inset:0;
  background:rgba(6,10,18,.35);
  backdrop-filter: blur(8px);
  z-index:45;
}
.restOverlay.hidden{display:none}
.restPopup::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:20px;
  border:1px solid rgba(122,162,255,.35);
  pointer-events:none;
}
.restPopup.hidden{display:none}
.restPopup .time{font-size:40px}
.restPopup .row{justify-content:space-between}
.restPopup .timerControls{gap:6px}
body.light .restOverlay{
  background:rgba(15,23,42,.12);
  backdrop-filter: blur(6px);
}
body.light .restPopup{
  background:linear-gradient(135deg, #ffffff, #f1f5f9);
  border:1px solid rgba(49,130,206,.35);
  box-shadow:0 16px 40px rgba(15,23,42,.12), 0 0 12px rgba(49,130,206,.15);
}
body.light .restPopup::before{
  border-color:rgba(49,130,206,.25);
}
.time{
  font-family:var(--mono);
  font-size:28px;
  letter-spacing:.5px;
}
.time.compact{font-size:22px}
.stickyTop{
  position:sticky;
  top:calc(8px + var(--sat));
  z-index:0;
}
.stickyTop.card{
  background:var(--card);
}
.stickyTop .ch{padding:10px 12px}
.stickyTop .cb{padding:10px 12px}
.stickyTop .btn{padding:8px 10px; font-size:12px}
.stickyTop .timerControls{gap:6px; margin-top:8px}
.stickyTop .time.compact{font-size:20px}
.timerControls{
  display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
}
.inputMini{
  width:72px;
  padding:8px 8px;
  border-radius:10px;
  border:1px solid var(--line);
  background:var(--input-bg);
  color:var(--text);
  font-size:12px;
}
.dashTable{
  margin-top:10px;
  display:grid;
  grid-template-columns: 1.2fr .7fr .8fr .9fr .8fr;
  gap:8px;
  align-items:center;
}
.dashTableWide{
  margin-top:10px;
  display:grid;
  grid-template-columns: 1.4fr .7fr .7fr .7fr .7fr;
  gap:8px;
  align-items:center;
}
.dashHead{
  font-size:11px; color:var(--muted); padding:0 2px;
}
.dashCell{
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--line);
  background:var(--ui-bg);
  font-size:12px;
}
.compareRow{
  grid-column:1/-1;
  font-size:11px;
  color:var(--muted);
  padding:2px 2px 6px;
}
.menuBtn{
  font-size:20px; padding:6px 12px;
}
.menuLayer{
  position:fixed;
  inset:0;
  z-index:2147483647;
  pointer-events:none;
}
.menuOverlay{
  position:fixed; inset:0; z-index:0; display:none;
  pointer-events:auto;
}
.menuOverlay.show{ display:block; }
.menuPopup{
  position:fixed;
  top:calc(var(--sat) + 50px);
  right:14px;
  width:180px;
  background-color:var(--menu-bg);
  background-image:none;
  opacity:1;
  border:1px solid var(--line);
  border-radius:16px; box-shadow:var(--shadow);
  padding:8px; z-index:1; display:none;
  flex-direction:column; gap:4px;
  pointer-events:auto;
  transform: translateZ(0);
}
.menuPopup.show{ display:flex; }
.menuItem{
  background:transparent; border:0; color:var(--text);
  text-align:left; padding:10px; font-weight:700; font-size:13px;
  border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:10px;
  font-family:var(--sans);
}
.menuItem:hover{ background:var(--line); }
.menuItem.bad{ color:var(--bad); }
.suggestion{
  margin-top:8px; padding:8px 10px; border-radius:10px;
  background:rgba(53,208,127,.10); border:1px solid rgba(53,208,127,.30);
  color:var(--good); font-size:12px; font-weight:700;
  display:flex; align-items:center; gap:8px;
}
.safe-area-fix{
  position:fixed; top:0; left:0; right:0;
  height:var(--sat);
  background:var(--header-bg);
  backdrop-filter:blur(10px);
  z-index:101;
  pointer-events:none;
}
</style>
</head>
<body>
<div class="safe-area-fix"></div>

<header>
  <div class="wrap">
    <div class="head">
      <div>
        <h1>5-Day Workout + Mobility Tracker</h1>
        <div class="sub">Lift hard, recover, hit steps, keep conditioning consistent. Saves on-device.</div>
      </div>
      <div class="row" style="position:relative">
        <button class="btn menuBtn" id="menuToggle">‚ò∞</button>
        <input type="file" id="importFile" style="display:none" accept=".json">
      </div>
    </div>
  </div>
</header>

<div class="menuLayer" id="menuLayer">
  <div class="menuOverlay" id="menuOverlay"></div>
  <div class="menuPopup" id="menuPopup">
    <button class="menuItem" id="themeToggle"><span>üåó</span> <span>Theme</span></button>
    <div class="hr" style="margin:4px 0"></div>
    <button class="menuItem" id="importBtn"><span>üìÇ</span> <span>Import</span></button>
    <button class="menuItem" id="exportBtn"><span>üíæ</span> <span>Export</span></button>
    <button class="menuItem bad" id="resetBtn"><span>‚ö†Ô∏è</span> <span>Reset</span></button>
  </div>
</div>

<main id="app"></main>

<div class="footerTabs">
  <div class="footerInner">
    <div class="tabs" id="tabs"></div>
    <div class="kpi">
      <span class="badge">Week: <span class="mono" id="weekLbl"></span></span>
      <span class="badge">Completed: <span class="mono" id="completedLbl">0</span>/5</span>
      <button class="btn primary" id="dashboardBtn">Dashboard</button>
    </div>
  </div>
</div>

<script>
(() => {
  const KEY = "workout_tracker_fatloss_v2";

  // Recommended information taken from the plan previously provided:
  // - Compound lifts: moderate-heavy with 1‚Äì2 reps in reserve, rest 90‚Äì180s
  // - Accessories: higher reps, rest 45‚Äì90s
  // - Conditioning day: circuit style, 60‚Äì90s between stations/rounds

  const PLAN = [
    {
      id:"d1", short:"Day 1", title:"Upper Push",
      mobility:[
        {name:"Thoracic extensions (foam roller)", dose:"2√ó8 slow reps", cue:"Exhale into extension; avoid cranking the neck."},
        {name:"Band shoulder pass-throughs", dose:"2√ó10", cue:"Ribs down; smooth range."},
        {name:"Scap push-ups", dose:"2√ó10", cue:"Move shoulder blades; elbows stay locked."},
      ],
      lifts:[
        {name:"Bench Press (BB or DB)", sets:4, reps:"6‚Äì8", rest:"90‚Äì150s", cue:"Stop with 1‚Äì2 reps in reserve; controlled descent.", options:["BB","DB"]},
        {name:"Incline Bench Press (BB or DB)", sets:3, reps:"8‚Äì10", rest:"90s", cue:"Full range; do not bounce.", options:["BB","DB"]},
        {name:"DB Overhead Press (Standing or Seated)", sets:3, reps:"6‚Äì8", rest:"120s", cue:"Glutes tight; avoid excessive low-back arch.", options:["Standing","Seated"], cues:{
          "Standing": "Glutes tight, ribs down; avoid excessive low-back arch.",
          "Seated": "Tall posture, slight back support; keep ribs stacked over hips."
        }},
        {name:"DB Lateral Raise", sets:3, reps:"12‚Äì15", rest:"60s", cue:"No shrugging; slow lower."},
        {name:"Triceps Pushdown (or Dips)", sets:3, reps:"10‚Äì12", rest:"60‚Äì90s", cue:"Elbows pinned; full extension.", options:["Pushdown","Dips"]},
        { name:"Cable or DB Chest Fly", sets:3, reps:"12‚Äì15", rest:"60s", cue:"Soft elbows; stretch under control.", options:["Cable","DB"] },
        { name:"Overhead Tricep Extension (DB or Cable)", sets:3, reps:"10‚Äì12", rest:"60‚Äì90s", cue:"Elbows narrow; full stretch.", options:["DB","Cable"], cues:{
          "DB": "Elbows tucked; let the DB travel behind head for a full stretch.",
          "Cable": "Keep constant tension; elbows fixed, smooth lockout."
        } },
      ],
      conditioning:{label:"Optional finisher", rx:"Push-ups: 2 rounds near-failure (stop 1‚Äì2 reps before form breaks)."}
    },
    {
      id:"d2", short:"Day 2", title:"Lower Body",
      mobility:[
        {name:"90/90 hip switches", dose:"2√ó6/side", cue:"Stay tall; move slowly into range."},
        {name:"World‚Äôs Greatest Stretch", dose:"1‚Äì2√ó/side", cue:"Long exhale; rotate through upper back."},
        {name:"Ankle dorsiflexion rocks", dose:"2√ó10/side", cue:"Heel stays down; knee tracks over toes."},
      ],
      lifts:[
        {name:"Squat (Back or Front)", sets:4, reps:"5‚Äì8", rest:"120‚Äì180s", cue:"Brace hard; consistent depth; clean reps.", options:["Back","Front"]},
        {name:"Romanian Deadlift", sets:3, reps:"8", rest:"120s", cue:"Hinge; neutral spine; feel hamstrings."},
        {name:"Walking Lunges", sets:3, reps:"12/leg", rest:"90s", cue:"Long stride; stable knee."},
        {name:"Standing Calf Raises", sets:4, reps:"12‚Äì15", rest:"60s", cue:"Pause at top and bottom."},
        {name:"Plank (Front or Side)", sets:3, reps:"45‚Äì60s", rest:"45‚Äì60s", cue:"Ribs down; squeeze glutes; breathe.", options:["Front","Side"]},
        { name:"Leg Curl (Machine or Band)", sets:3, reps:"10‚Äì15", rest:"60‚Äì90s", cue:"Control; squeeze hamstrings.", options:["Machine","Band"] },
        { name:"Hip Thrust (BB or DB)", sets:3, reps:"8‚Äì12", rest:"90s", cue:"Posterior tilt; pause at top.", options:["BB","DB"] },
      ],
      conditioning:{label:"Optional Zone 2", rx:"Incline treadmill walk: 10 minutes easy (conversational pace)."}
    },
    {
      id:"d3", short:"Day 3", title:"Upper Pull",
      mobility:[
        {name:"Dead hang (passive)", dose:"2√ó20‚Äì40s", cue:"Relax shoulders; no forced stretch."},
        {name:"Band pull-aparts", dose:"2√ó15", cue:"Squeeze shoulder blades; avoid arching back."},
        {name:"Cat-cow", dose:"1√ó8", cue:"Segment the spine; slow controlled motion."},
      ],
      lifts:[
        {name:"Pull-ups (or Lat Pulldown)", sets:4, reps:"6‚Äì10", rest:"120s", cue:"Full stretch at bottom; no kipping.", options:["Pull-ups","Lat Pulldown"]},
        {name:"Row (BB or DB)", sets:3, reps:"8‚Äì10", rest:"120s", cue:"Pull to hip; keep neck neutral.", options:["BB","DB"]},
        {name:"Three Point DB Row", sets:3, reps:"10/side", rest:"90s", cue:"Pause at top; controlled lower."},
        {name:"Face Pulls", sets:3, reps:"12‚Äì15", rest:"60s", cue:"Elbows high; squeeze rear delts."},
        {name:"Biceps Curl (BB or DB)", sets:3, reps:"10‚Äì12", rest:"60‚Äì90s", cue:"No swing; full extension.", options:["BB","DB"]},
        { name:"Rear Delt Fly (DB or Cable)", sets:3, reps:"12‚Äì15", rest:"60s", cue:"Lead with elbows; no shrug.", options:["DB","Cable"] },
        { name:"Hammer Curl or Preacher Curl", sets:3, reps:"10‚Äì12", rest:"60‚Äì90s", cue:"Neutral wrist; no swing.", options:["Hammer Curl","Preacher Curl"], cues:{
          "Hammer Curl": "Neutral wrist; keep elbows pinned, no swing.",
          "Preacher Curl": "Elbows fixed on pad; full stretch and controlled reps."
        } },
      ],
      conditioning:{label:"Optional intervals", rx:"Rower: 8 min (20s hard / 40s easy). Keep technique clean."}
    },
    {
      id:"d4", short:"Day 4", title:"Conditioning + Core",
      mobility:[
        {name:"Couch stretch (hip flexor)", dose:"1‚Äì2√ó45s/side", cue:"Posterior pelvic tilt; squeeze glute."},
        {name:"Open books (T-spine rotation)", dose:"1√ó8/side", cue:"Knees stacked; slow rotation."},
        {name:"90/90 breathing reset", dose:"2 minutes", cue:"Long exhale; ribs down."},
      ],
      lifts:[
        {name:"Kettlebell Swings", sets:4, reps:"20", rest:"60‚Äì90s", cue:"Hinge; snap hips; neutral spine."},
        {name:"Box Jumps (or Step-ups)", sets:4, reps:"10", rest:"60‚Äì90s", cue:"Land softly; stop before sloppy reps.", options:["Box Jump","Step-up"]},
        {name:"Burpees", sets:4, reps:"10‚Äì15", rest:"60‚Äì90s", cue:"Chest to floor; jump at top."},
        {name:"Hanging Leg Raises (or Dead Bug)", sets:4, reps:"10‚Äì15", rest:"60‚Äì90s", cue:"Control; no swinging.", options:["Hanging","Dead Bug"]},
        {name:"Ab Wheel (or Plank)", sets:4, reps:"8‚Äì10", rest:"60‚Äì90s", cue:"Ribs down; no low-back sag.", options:["Ab Wheel","Plank"]},
        { name:"Sled Push (or Bike Sprint)", sets:6, reps:"20‚Äì30s", rest:"60‚Äì90s", cue:"Strong posture; steady drive.", options:["Sled Push","Bike Sprint"], cues:{
            "Sled Push": "Strong posture; steady drive.",
            "Bike Sprint": "High resistance; stand up and drive hard."
          }
        },
        { name:"Russian Twists", sets:3, reps:"12‚Äì15/side", rest:"45‚Äì60s", cue:"Rotate shoulders, not just hands; control tempo." },
      ],
      conditioning:{label:"Zone 2 add-on", rx:"Optional: 10‚Äì20 minutes Zone 2 (easy conversational pace)."}
    },
    {
      id:"d5", short:"Day 5", title:"Full Body",
      mobility:[
        {name:"Glute bridge", dose:"2√ó10", cue:"Posterior tilt; feel glutes, not low back."},
        {name:"Hamstring floss (gentle)", dose:"1√ó10", cue:"No ballistic stretching; easy range."},
        {name:"Band external rotations", dose:"2√ó12", cue:"Elbow pinned to side; slow rotation."},
      ],
      lifts:[
        {name:"Deadlift (moderate load)", sets:3, reps:"5", rest:"150‚Äì180s", cue:"Crisp reps; stop short of grinding."},
        {name:"Incline Bench Press (BB or DB)", sets:3, reps:"8‚Äì10", rest:"90s", cue:"Full range; do not bounce.", options:["BB","DB"]},
        {name:"Chin-ups (or assisted)", sets:3, reps:"AMRAP", rest:"120s", cue:"Stop 1 rep before form breaks.", options:["Chin-ups","Assisted"]},
        {name:"Goblet Squat", sets:3, reps:"12", rest:"90s", cue:"Upright torso; elbows inside knees."},
        {name:"Farmer‚Äôs Carries", sets:3, reps:"40‚Äì60s", rest:"60‚Äì90s", cue:"Tall posture; slow controlled steps."},
        { name:"Seated Cable Row (or Chest-Supported Row)", sets:3, reps:"10‚Äì12", rest:"90s", cue:"Pause at squeeze; no jerking.", options:["Cable","Chest-Supported"] },
        { name:"DB Bulgarian Split Squat", sets:3, reps:"8‚Äì10/leg", rest:"90s", cue:"Vertical shin; control depth." },
      ],
      conditioning:{label:"Optional easy finish", rx:"Incline walk: 8‚Äì12 minutes easy."}
    }
  ];

  const $ = (s, el=document) => el.querySelector(s);

  function isoDate(d=new Date()){ return d.toISOString().slice(0,10); }
  function weekStartKey(d=new Date()){
    const x = new Date(d);
    const day = (x.getDay()+6)%7; // Mon=0
    x.setDate(x.getDate()-day);
    return isoDate(x);
  }
  function weekStartKeyWithCutoff(d=new Date()){
    const x = new Date(d);
    if(x.getDay() === 0 && x.getHours() >= 23){
      return weekStartKey(addDays(x, 1));
    }
    return weekStartKey(x);
  }
  function addDays(d, n){
    const x = new Date(d);
    x.setDate(x.getDate() + n);
    return x;
  }
  function nextSundayAt23(d=new Date()){
    const x = new Date(d);
    const day = x.getDay(); // Sun=0
    let daysUntil = (7 - day) % 7;
    if(day === 0 && x.getHours() >= 23) daysUntil = 7;
    const target = addDays(x, daysUntil);
    target.setHours(23, 0, 0, 0);
    return target;
  }

  function load(){
    try{ return JSON.parse(localStorage.getItem(KEY)) || null; }catch(e){ return null; }
  }
  function save(state){
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  function defaultState(){
    return {
      weekStart: weekStartKeyWithCutoff(),
      activeDayId: PLAN[0].id,
      sessions: {}, // weekStart -> dayId -> data
      viewWeekStart: null,
      timers: {
        restDuration: 90,
        restRemaining: 90,
        workoutElapsed: 0,
        theme: "dark"
      }
    };
  }

  let state = load() || defaultState();
  const openLifts = new Set();
  const timers = {
    rest:{duration:90, remaining:90, running:false, interval:null},
    workout:{elapsed:0, running:false, interval:null}
  };
  let weeklyRolloverTimer = null;

  // Apply theme immediately
  if(!state.theme) state.theme = "dark";
  if(state.theme === "light") document.body.classList.add("light");
  else document.body.classList.remove("light");

  function ensureWeek(){
    const wk = weekStartKeyWithCutoff();
    if(state.weekStart !== wk){
      const oldWeek = state.weekStart;
      state.weekStart = wk;
      state.activeDayId = PLAN[0].id;
      if(!state.viewWeekStart || state.viewWeekStart === oldWeek){
        state.viewWeekStart = wk;
      }
    }
    if(!state.sessions[state.weekStart]) state.sessions[state.weekStart] = {};
    if(!state.viewWeekStart) state.viewWeekStart = state.weekStart;
  }

  function scheduleWeeklyRollover(){
    if(weeklyRolloverTimer){
      clearTimeout(weeklyRolloverTimer);
      weeklyRolloverTimer = null;
    }
    const now = new Date();
    const target = nextSundayAt23(now);
    const ms = Math.max(1000, target.getTime() - now.getTime());
    weeklyRolloverTimer = setTimeout(() => {
      ensureWeek();
      state.viewWeekStart = state.weekStart;
      save(state);
      render();
      scheduleWeeklyRollover();
    }, ms);
  }

  function ensureTimers(){
    if(!state.timers) state.timers = {restDuration:90, restRemaining:90, workoutElapsed:0};
    if(!Number.isFinite(state.timers.restDuration)) state.timers.restDuration = 90;
    if(!Number.isFinite(state.timers.restRemaining)) state.timers.restRemaining = state.timers.restDuration;
    if(!Number.isFinite(state.timers.workoutElapsed)) state.timers.workoutElapsed = 0;
    timers.rest.duration = state.timers.restDuration;
    timers.rest.remaining = state.timers.restRemaining;
    timers.workout.elapsed = state.timers.workoutElapsed;
    persistTimers();
  }

  function persistTimers(){
    state.timers = {
      restDuration: timers.rest.duration,
      restRemaining: timers.rest.remaining,
      workoutElapsed: timers.workout.elapsed
    };
    save(state);
  }

  function getSession(dayId){
    ensureWeek();
    const wk = state.weekStart;
    if(!state.sessions[wk][dayId]){
      state.sessions[wk][dayId] = {
        completed:false,
        mobilityDone:{},
        liftSets:{},  // liftName[::option] -> [{reps,weight,rpe,done}]
        liftOptions:{},
        extraSets:{},     // NEW: liftStorageKey -> number of extra sets
        conditioningMinutes:"",
        conditioningPushups:{set1:"", set2:""},
        dayLocked:false
      };
    }
    return state.sessions[wk][dayId];
  }

  function countCompleted(){
    ensureWeek();
    const wk = state.weekStart;
    const obj = state.sessions[wk] || {};
    return Object.values(obj).filter(s => s && s.completed).length;
  }
  function countCompletedForWeek(weekKey){
    const obj = state.sessions[weekKey] || {};
    return Object.values(obj).filter(s => s && s.completed).length;
  }

  function renderTabs(){
    const tabs = $("#tabs");
    tabs.innerHTML = "";
    PLAN.forEach(d => {
      const b = document.createElement("button");
      b.className = "tab" + (d.id === state.activeDayId ? " active" : "");
      b.textContent = d.short;
      b.onclick = () => { state.activeDayId = d.id; save(state); render(); };
      tabs.appendChild(b);
    });
    $("#weekLbl").textContent = state.weekStart;
    $("#completedLbl").textContent = String(countCompleted());
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function clamp(n, min, max){ return Math.min(max, Math.max(min, n)); }
  function formatTime(totalSec){
    const s = Math.max(0, Math.floor(totalSec));
    const m = Math.floor(s / 60);
    const r = s % 60;
    return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
  }
  function weekSummaryCompletedRatio(sessions){
    const completed = PLAN.reduce((sum, d) => sum + (sessions[d.id] && sessions[d.id].completed ? 1 : 0), 0);
    return completed / PLAN.length;
  }
  function prevWeekKey(weekKey){
    return isoDate(addDays(new Date(weekKey + "T00:00:00"), -7));
  }
  function weekHasAnyData(weekKey){
    const sessions = state.sessions[weekKey] || {};
    return Object.values(sessions).some(s => {
      if(!s) return false;
      if(s.completed) return true;
      if(s.notes && String(s.notes).trim()) return true;
      if(s.conditioningMinutes && parseFloat(s.conditioningMinutes)) return true;
      if(s.mobilityDone && Object.values(s.mobilityDone).some(Boolean)) return true;
      if(s.liftSets && Object.values(s.liftSets).some(arr => hasLiftData(arr))) return true;
      return false;
    });
  }
  function prevWeekWithData(weekKey){
    const weeks = Object.keys(state.sessions || {})
      .filter(w => w < weekKey)
      .sort((a,b) => b.localeCompare(a));
    for(const wk of weeks){
      if(weekHasAnyData(wk)) return wk;
    }
    return null;
  }
  function parseNum(v){
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : null;
  }
  function displayNameFromStorageKey(key){
    const parts = String(key).split("::");
    if(parts.length > 1){
      return `${parts[0]} (${parts.slice(1).join("::")})`;
    }
    return key;
  }
  function exerciseStatsForWeek(weekKey){
    const sessions = state.sessions[weekKey] || {};
    const stats = {};
    Object.values(sessions).forEach(s => {
      if(!s || !s.liftSets) return;
      Object.entries(s.liftSets).forEach(([key, arr]) => {
        const name = displayNameFromStorageKey(key);
        if(!stats[name]) stats[name] = {maxWeight:null, volume:0};
        (arr || []).forEach(set => {
          if(!set || !set.done) return;
          const w = parseNum(set.weight);
          const r = parseNum(set.reps);
          if(w !== null){
            stats[name].maxWeight = stats[name].maxWeight === null ? w : Math.max(stats[name].maxWeight, w);
          }
          if(w !== null && r !== null){
            stats[name].volume += w * r;
          }
        });
      });
    });
    return stats;
  }
  function formatDelta(n){
    if(n === null || n === undefined || Number.isNaN(n)) return "‚Äî";
    const rounded = Math.round(n * 10) / 10;
    const sign = rounded > 0 ? "+" : "";
    return `${sign}${rounded}`;
  }
  function formatNumber(n){
    if(n === null || n === undefined || Number.isNaN(n)) return "‚Äî";
    const rounded = Math.round(n * 10) / 10;
    return String(rounded);
  }

  function applyDayLock(container, locked){
    if(!container) return;
    container.querySelectorAll("input, textarea, select, button").forEach(el => {
      if(el.hasAttribute("data-allow-when-locked")) return;
      el.disabled = !!locked;
    });
  }

  function getOverloadSuggestion(lift, prevSets){
    // 1. Check for valid history
    const valid = prevSets.filter(s => s.done && parseNum(s.weight) !== null && parseNum(s.reps) !== null);
    if(!valid.length) return null;

    // 2. Find best set (heaviest weight, then most reps)
    valid.sort((a,b) => {
      const wA = parseNum(a.weight), wB = parseNum(b.weight);
      if(wA !== wB) return wB - wA;
      return parseNum(b.reps) - parseNum(a.reps);
    });
    const best = valid[0];
    const lastWeight = parseNum(best.weight);
    const lastReps = parseNum(best.reps);

    // 3. Parse target reps (e.g. "6‚Äì8" -> 8)
    if(lift.reps.toLowerCase().includes("amrap")) return `Beat ${lastReps} reps @ ${lastWeight} lbs`;
    const nums = lift.reps.match(/\d+/g);
    if(!nums) return null;
    const maxTarget = parseInt(nums[nums.length-1]);

    // 4. Generate Tip
    if(lastReps >= maxTarget){
      return `Target hit! Try ${lastWeight + 5} lbs`;
    } else {
      return `Aim for ${lastReps + 1} reps @ ${lastWeight} lbs`;
    }
  }

  let audioCtx = null;
  let audioUnlocked = false;
  let noiseBuffer = null;
  let wakeLock = null;
  let wakeLockEnabled = false;
  async function resumeAudioIfNeeded(){
    try{
      if(!audioCtx) return;
      if(audioCtx.state === "suspended") await audioCtx.resume();
      audioUnlocked = audioCtx.state === "running";
    }catch(e){
      audioUnlocked = false;
    }
  }
  function playBeep(){
    try{
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) return;
      audioCtx = audioCtx || new Ctx();
      if(audioCtx.state === "suspended") audioCtx.resume();
      audioUnlocked = audioCtx.state === "running";
      const drop = (t) => {

        const carrier = audioCtx.createOscillator();
        const mod = audioCtx.createOscillator();
        const modGain = audioCtx.createGain();
        const gain = audioCtx.createGain();
        const filter = audioCtx.createBiquadFilter();

        carrier.type = "sine";
        carrier.frequency.setValueAtTime(640, t);
        carrier.frequency.exponentialRampToValueAtTime(420, t + 0.18);

        mod.type = "sine";
        mod.frequency.setValueAtTime(28, t);
        modGain.gain.setValueAtTime(10, t);
        modGain.gain.exponentialRampToValueAtTime(0.1, t + 0.25);

        filter.type = "lowpass";
        filter.frequency.setValueAtTime(1800, t);
        filter.Q.value = 0.7;

        gain.gain.setValueAtTime(0.0001, t);
        gain.gain.exponentialRampToValueAtTime(0.9, t + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.22);

        mod.connect(modGain);
        modGain.connect(carrier.frequency);
        carrier.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);

        carrier.start(t);
        mod.start(t);
        carrier.stop(t + 0.24);
        mod.stop(t + 0.24);
      };
      const base = audioCtx.currentTime + 0.02;
      drop(base);
      drop(base + 1.0);
      drop(base + 2.0);
    }catch(e){}
    if(navigator.vibrate){
      navigator.vibrate(120);
      setTimeout(() => navigator.vibrate(120), 1000);
      setTimeout(() => navigator.vibrate(120), 2000);
    }
  }
  async function unlockAudio(){
    try{
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) return false;
      audioCtx = audioCtx || new Ctx();
      if(audioCtx.state === "suspended") await audioCtx.resume();
      audioUnlocked = audioCtx.state === "running";
      if(audioUnlocked){
        // short tap to confirm unlock
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.35;
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15);
        o.stop(audioCtx.currentTime + 0.15);
      }
      updateTimersUI();
      return audioUnlocked;
    }catch(e){
      updateTimersUI();
      return false;
    }
  }

  function stopRestTimer(){
    if(timers.rest.interval){
      clearInterval(timers.rest.interval);
      timers.rest.interval = null;
    }
    timers.rest.running = false;
    updateWakeLock();
  }
  function showRestPopup(){
    const el = $("#restPopup");
    if(el) el.classList.remove("hidden");
    const overlay = $("#restOverlay");
    if(overlay) overlay.classList.remove("hidden");
  }
  function hideRestPopup(){
    const el = $("#restPopup");
    if(el) el.classList.add("hidden");
    const overlay = $("#restOverlay");
    if(overlay) overlay.classList.add("hidden");
  }
  function startRestTimer(){
    if(timers.rest.running) return;
    timers.rest.remaining = timers.rest.duration;
    timers.rest.running = true;
    updateWakeLock();
    timers.rest.interval = setInterval(() => {
      timers.rest.remaining -= 1;
      if(timers.rest.remaining <= 0){
        timers.rest.remaining = 0;
        stopRestTimer();
        playBeep();
        setTimeout(() => hideRestPopup(), 2600);
      }
      persistTimers();
      updateTimersUI();
    }, 1000);
    showRestPopup();
    updateTimersUI();
  }

  function stopWorkoutTimer(){
    if(timers.workout.interval){
      clearInterval(timers.workout.interval);
      timers.workout.interval = null;
    }
    timers.workout.running = false;
    updateWakeLock();
  }

  function updateTimersUI(){
    const restTimeEl = $("#restTime");
    const workoutTimeEl = $("#workoutTime");
    if(restTimeEl) restTimeEl.textContent = formatTime(timers.rest.remaining);
    if(workoutTimeEl) workoutTimeEl.textContent = formatTime(timers.workout.elapsed);
    const restStatus = $("#restStatus");
    if(restStatus) restStatus.textContent = timers.rest.running ? "Running" : "Ready";
    const workoutStatus = $("#workoutStatus");
    if(workoutStatus) workoutStatus.textContent = timers.workout.running ? "Running" : "Paused";
    const restPopupTime = $("#restPopupTime");
    if(restPopupTime) restPopupTime.textContent = formatTime(timers.rest.remaining);
    const restPopupStatus = $("#restPopupStatus");
    if(restPopupStatus) restPopupStatus.textContent = timers.rest.running ? "Running" : "Paused";
    const restPauseBtn = $("#restPauseBtn");
    if(restPauseBtn) restPauseBtn.textContent = timers.rest.running ? "Pause" : "Resume";
    const restDurationLbl = $("#restDurationLbl");
    if(restDurationLbl) restDurationLbl.textContent = formatTime(timers.rest.duration);
    const enableAudioBtn = $("#enableAudioBtn");
    if(enableAudioBtn) enableAudioBtn.style.display = audioUnlocked ? "none" : "inline-flex";
  }

  async function requestWakeLock(){
    if(!("wakeLock" in navigator)) return;
    try{
      wakeLock = await navigator.wakeLock.request("screen");
      wakeLockEnabled = true;
      wakeLock.addEventListener("release", () => {
        wakeLockEnabled = false;
      });
    }catch(e){
      wakeLockEnabled = false;
    }
  }
  function releaseWakeLock(){
    if(wakeLock){
      wakeLock.release().catch(() => {});
      wakeLock = null;
    }
    wakeLockEnabled = false;
  }
  function updateWakeLock(){
    const shouldHold = timers.rest.running;
    if(shouldHold){
      if(document.visibilityState === "visible" && !wakeLockEnabled){
        requestWakeLock();
      }
    }else{
      releaseWakeLock();
    }
  }

  document.addEventListener("visibilitychange", () => {
    if(document.visibilityState === "visible"){
      resumeAudioIfNeeded();
      updateTimersUI();
      updateWakeLock();
    }
  });

  function wireTimers(){
    const restMin = $("#restMin");
    const restSec = $("#restSec");
    const restSetBtn = $("#restSetBtn");
    const restPauseBtn = $("#restPauseBtn");
    const restResetBtn = $("#restResetBtn");
    const restCloseBtn = $("#restCloseBtn");
    const restPlusBtn = $("#restPlusBtn");
    const restMinusBtn = $("#restMinusBtn");

    if(restMin && restSec){
      const m = Math.floor(timers.rest.duration / 60);
      const s = timers.rest.duration % 60;
      restMin.value = String(m);
      restSec.value = String(s);
    }

    if(restSetBtn){
      restSetBtn.onclick = () => {
        const m = clamp(parseInt(restMin.value || "0", 10) || 0, 0, 59);
        const s = clamp(parseInt(restSec.value || "0", 10) || 0, 0, 59);
        const total = Math.max(5, (m * 60) + s);
        stopRestTimer();
        timers.rest.duration = total;
        timers.rest.remaining = total;
        persistTimers();
        updateTimersUI();
      };
    }

    if(restPauseBtn){
      restPauseBtn.onclick = () => {
        if(timers.rest.running){
          stopRestTimer();
        }else{
          startRestTimer();
        }
        persistTimers();
        updateTimersUI();
      };
    }

    if(restResetBtn){
      restResetBtn.onclick = () => {
        stopRestTimer();
        timers.rest.remaining = timers.rest.duration;
        persistTimers();
        updateTimersUI();
      };
    }

    if(restCloseBtn){
      restCloseBtn.onclick = () => {
        stopRestTimer();
        persistTimers();
        hideRestPopup();
        updateTimersUI();
      };
    }

    const enableAudioBtn = $("#enableAudioBtn");
    if(enableAudioBtn){
      enableAudioBtn.onclick = () => {
        unlockAudio();
        updateTimersUI();
      };
    }

    const adjustRest = (delta) => {
      timers.rest.remaining = clamp(timers.rest.remaining + delta, 5, 60 * 30);
      persistTimers();
      updateTimersUI();
    };
    if(restPlusBtn) restPlusBtn.onclick = () => adjustRest(15);
    if(restMinusBtn) restMinusBtn.onclick = () => adjustRest(-15);

    const workoutStartBtn = $("#workoutStartBtn");
    const workoutPauseBtn = $("#workoutPauseBtn");
    const workoutResetBtn = $("#workoutResetBtn");

    if(workoutStartBtn){
      workoutStartBtn.onclick = () => {
        if(timers.workout.running) return;
        timers.workout.running = true;
        updateWakeLock();
        timers.workout.interval = setInterval(() => {
          timers.workout.elapsed += 1;
          persistTimers();
          updateTimersUI();
        }, 1000);
        updateTimersUI();
      };
    }

    if(workoutPauseBtn){
      workoutPauseBtn.onclick = () => {
        stopWorkoutTimer();
        persistTimers();
        updateTimersUI();
      };
    }

    if(workoutResetBtn){
      workoutResetBtn.onclick = () => {
        if(!confirm("Reset workout timer?")) return;
        stopWorkoutTimer();
        timers.workout.elapsed = 0;
        persistTimers();
        updateTimersUI();
      };
    }
  }

  function liftOptionKey(dayId, lift){
    return `${dayId}::${lift.name}`;
  }
  function liftStorageKey(lift, option){
    if(lift.options && option) return `${lift.name}::${option}`;
    return lift.name;
  }
  function getExtraSets(session, lift, option){
    if(!session.extraSets) session.extraSets = {};
    const key = liftStorageKey(lift, option);
    return session.extraSets[key] || 0;
  }
  function setExtraSets(session, lift, option, n){
    if(!session.extraSets) session.extraSets = {};
    const key = liftStorageKey(lift, option);
    session.extraSets[key] = Math.max(0, n|0);
  }
  function findStoredOption(session, lift){
    if(!session || !session.liftSets || !lift.options) return null;
    const prefix = `${lift.name}::`;
    const match = Object.keys(session.liftSets).find(k => k.startsWith(prefix));
    return match ? match.slice(prefix.length) : null;
  }
  function resolveLiftOption(session, dayId, lift){
    if(!lift.options || !lift.options.length) return null;
    const key = liftOptionKey(dayId, lift);
    if(session && session.liftOptions && lift.options.includes(session.liftOptions[key])){
      return session.liftOptions[key];
    }
    if(session && session.liftSets && session.liftSets[lift.name]){
      return lift.options[0];
    }
    const stored = findStoredOption(session, lift);
    if(stored && lift.options.includes(stored)) return stored;
    return lift.options[0];
  }
  function getLiftOption(session, dayId, lift){
    const opt = resolveLiftOption(session, dayId, lift);
    if(!opt) return null;
    if(!session.liftOptions) session.liftOptions = {};
    const key = liftOptionKey(dayId, lift);
    if(session.liftOptions[key] !== opt){
      session.liftOptions[key] = opt;
    }
    return opt;
  }
  function ensureLiftArray(session, lift, option){
    const key = liftStorageKey(lift, option);

    // migrate old key if options changed
    if(lift.options && !session.liftSets[key] && session.liftSets[lift.name]){
      session.liftSets[key] = session.liftSets[lift.name];
      delete session.liftSets[lift.name];
    }

    if(!session.liftSets[key]) session.liftSets[key] = [];

    // total sets = planned sets + user-added extra sets (per lift/option)
    const extra = getExtraSets(session, lift, option);
    const targetLen = (lift.sets || 0) + extra;

    const arr = session.liftSets[key];
    while(arr.length < targetLen) arr.push({reps:"", weight:"", rpe:"", done:false});
    if(arr.length > targetLen) arr.length = targetLen;

    return arr;
  }
  function getLiftSets(session, dayId, lift){
    if(!session || !session.liftSets) return [];
    const opt = resolveLiftOption(session, dayId, lift);
    const key = liftStorageKey(lift, opt);
    if(session.liftSets[key]) return session.liftSets[key];
    if(lift.options && session.liftSets[lift.name]) return session.liftSets[lift.name];
    return [];
  }
  function liftDetailKey(dayId, lift){
    return `${dayId}::${lift.name}`;
  }
  function hasLiftData(sets){
    return (sets || []).some(s => s && (s.done || s.reps || s.weight || s.rpe));
  }
  function getPrevLiftData(dayId, lift, preferredOption){
    const currentWeek = state.weekStart;
    const weeks = Object.keys(state.sessions || {})
      .filter(w => w < currentWeek)
      .sort((a,b) => b.localeCompare(a));
    for(const wk of weeks){
      const s = state.sessions[wk] && state.sessions[wk][dayId];
      if(!s) continue;

      if(lift.options && lift.options.length){
        const opt = (preferredOption && lift.options.includes(preferredOption))
          ? preferredOption
          : resolveLiftOption(s, dayId, lift);
        const key = opt ? liftStorageKey(lift, opt) : lift.name;
        const sets = (s.liftSets && s.liftSets[key]) ? s.liftSets[key] : getLiftSets(s, dayId, lift);
        if(hasLiftData(sets)) return {weekKey:wk, session:s, option:opt, sets};

        if(s.liftSets){
          const prefix = `${lift.name}::`;
          const keys = Object.keys(s.liftSets).filter(k => k === lift.name || k.startsWith(prefix));
          for(const k of keys){
            const arr = s.liftSets[k] || [];
            if(hasLiftData(arr)){
              const opt2 = k.startsWith(prefix) ? k.slice(prefix.length) : lift.options[0];
              return {weekKey:wk, session:s, option:opt2, sets: arr};
            }
          }
        }
      }else{
        const sets = getLiftSets(s, dayId, lift);
        if(hasLiftData(sets)) return {weekKey:wk, session:s, option:null, sets};
      }
    }
    return {weekKey:null, session:null, option:null, sets:[]};
  }

  function updateAutoComplete(session, day){
    if(session.dayLocked){
      session.completed = true;
      return;
    }
    const anyMob = Object.values(session.mobilityDone || {}).some(Boolean);
    const anySet = day.lifts.some(l => {
      const arr = getLiftSets(session, day.id, l);
      return arr.some(s => s && s.done);
    });
    session.completed = anyMob || anySet;
  }

  function render(){
    ensureWeek();
    ensureTimers();
    const day = PLAN.find(d => d.id === state.activeDayId) || PLAN[0];
    const session = getSession(day.id);
    const prevCompleted = session.completed;
    updateAutoComplete(session, day);
    if(session.completed !== prevCompleted) save(state);

    const app = $("#app");

    const viewWeek = state.viewWeekStart || state.weekStart;
    const weekSummary = (() => {
      const wk = viewWeek;
      const sessions = state.sessions[wk] || {};
      let totalSets = 0;
      let doneSets = 0;
      let mobTotal = 0;
      let mobDone = 0;
      let condTotal = 0;
      const days = PLAN.map(d => {
        const s = sessions[d.id];
        const dayTotalSets = d.lifts.reduce((sum, l) => sum + l.sets, 0);
        totalSets += dayTotalSets;
        mobTotal += d.mobility.length;
        let dayDoneSets = 0;
        let dayMobDone = 0;
        let dayCond = 0;
        let completed = false;
        if(s){
          completed = !!s.completed;
          dayMobDone = Object.values(s.mobilityDone || {}).filter(Boolean).length;
          dayCond = parseFloat(s.conditioningMinutes) || 0;
          d.lifts.forEach(l => {
            const arr = getLiftSets(s, d.id, l);
            dayDoneSets += arr.filter(x => x.done).length;
          });
        }
        doneSets += dayDoneSets;
        mobDone += dayMobDone;
        condTotal += dayCond;
        return {
          title: d.title,
          completed,
          doneSets: dayDoneSets,
          totalSets: dayTotalSets,
          mobDone: dayMobDone,
          mobTotal: d.mobility.length,
          cond: dayCond
        };
      });
      const dayCompletion = weekSummaryCompletedRatio(sessions);
      const setsRatio = totalSets ? (doneSets / totalSets) : 0;
      const mobilityRatio = mobTotal ? (mobDone / mobTotal) : 0;
      const condRatio = clamp(condTotal / 60, 0, 1);
      const score = (dayCompletion * 0.45) + (setsRatio * 0.30) + (mobilityRatio * 0.15) + (condRatio * 0.10);
      const evaluation = score >= 0.85 ? "Great" : score >= 0.65 ? "Good" : "Needs improvement";
      return {
        days,
        totalSets,
        doneSets,
        mobTotal,
        mobDone,
        condTotal: Math.round(condTotal),
        completed: countCompletedForWeek(wk),
        evaluation
      };
    })();

    const allWeeks = Object.keys(state.sessions || {}).sort((a,b) => b.localeCompare(a));
    const prevWeekKeyStr = prevWeekWithData(viewWeek);
    const prevWeekSummary = prevWeekKeyStr ? (() => {
      const wk = prevWeekKeyStr;
      const sessions = state.sessions[wk] || {};
      let totalSets = 0;
      let doneSets = 0;
      let mobTotal = 0;
      let mobDone = 0;
      let condTotal = 0;
      PLAN.forEach(d => {
        const s = sessions[d.id];
        totalSets += d.lifts.reduce((sum, l) => sum + l.sets, 0);
        mobTotal += d.mobility.length;
        if(s){
          mobDone += Object.values(s.mobilityDone || {}).filter(Boolean).length;
          condTotal += parseFloat(s.conditioningMinutes) || 0;
          d.lifts.forEach(l => {
            const arr = getLiftSets(s, d.id, l);
            doneSets += arr.filter(x => x.done).length;
          });
        }
      });
      return {
        totalSets,
        doneSets,
        mobTotal,
        mobDone,
        condTotal: Math.round(condTotal),
        completed: countCompletedForWeek(wk)
      };
    })() : null;

    const exerciseNames = Array.from(new Set(PLAN.flatMap(d => d.lifts.flatMap(l => {
      if(l.options && l.options.length){
        return l.options.map(opt => `${l.name} (${opt})`);
      }
      return [l.name];
    }))));
    const currentStats = exerciseStatsForWeek(viewWeek);
    const prevStats = prevWeekKeyStr ? exerciseStatsForWeek(prevWeekKeyStr) : {};

    if(state.activeDayId === "dashboard"){
      app.innerHTML = `
        <details class="card" open>
          <summary>
            Weekly Dashboard
            <span class="badge">Week of ${viewWeek}</span>
          </summary>
          <div class="details-body">
            <div class="row" style="margin-bottom:10px">
              <span class="small" style="min-width:110px">View week:</span>
              <select id="weekSelect" class="inputMini" style="width:auto; min-width:140px">
                ${allWeeks.length ? allWeeks.map(w => `
                  <option value="${w}" ${w === viewWeek ? "selected":""}>${w}</option>
                `).join("") : `<option value="${viewWeek}" selected>${viewWeek}</option>`}
              </select>
              <span class="small">Dashboard only (workout view stays on current week).</span>
            </div>
            <div class="row">
              <span class="pill">Days <b>${weekSummary.completed}/5</b></span>
              <span class="pill">Sets <b>${weekSummary.doneSets}/${weekSummary.totalSets}</b></span>
              <span class="pill">Mobility <b>${weekSummary.mobDone}/${weekSummary.mobTotal}</b></span>
              <span class="pill">Conditioning <b>${weekSummary.condTotal} min</b></span>
              <span class="pill">Evaluation <b>${weekSummary.evaluation}</b></span>
            </div>
            <div class="row" style="margin-top:8px">
              <span class="small">Vs previous week${prevWeekKeyStr ? ` (${prevWeekKeyStr})` : ""}:</span>
              ${prevWeekSummary ? `
                <span class="pill">Days <b>${weekSummary.completed - prevWeekSummary.completed >= 0 ? "+" : ""}${weekSummary.completed - prevWeekSummary.completed}</b></span>
                <span class="pill">Sets <b>${weekSummary.doneSets - prevWeekSummary.doneSets >= 0 ? "+" : ""}${weekSummary.doneSets - prevWeekSummary.doneSets}</b></span>
                <span class="pill">Mobility <b>${weekSummary.mobDone - prevWeekSummary.mobDone >= 0 ? "+" : ""}${weekSummary.mobDone - prevWeekSummary.mobDone}</b></span>
                <span class="pill">Conditioning <b>${weekSummary.condTotal - prevWeekSummary.condTotal >= 0 ? "+" : ""}${weekSummary.condTotal - prevWeekSummary.condTotal} min</b></span>
              ` : `<span class="pill">No previous week data</span>`}
            </div>
            <div class="dashTable">
              <div class="dashHead">Day</div>
              <div class="dashHead">Status</div>
              <div class="dashHead">Sets</div>
              <div class="dashHead">Mobility</div>
              <div class="dashHead">Conditioning</div>
              ${weekSummary.days.map(d => `
                <div class="dashCell">${escapeHtml(d.title)}</div>
                <div class="dashCell">${d.completed ? "Cmp" : "In Prog"}</div>
                <div class="dashCell">${d.doneSets}/${d.totalSets}</div>
                <div class="dashCell">${d.mobDone}/${d.mobTotal}</div>
                <div class="dashCell">${Math.round(d.cond)} min</div>
              `).join("")}
            </div>
            <details>
              <summary>Exercise comparison to previous week (click to expand)</summary>
              <div class="details-body">
                <div class="dashTableWide">
                  <div class="dashHead">Exercise</div>
                  <div class="dashHead">Max</div>
                  <div class="dashHead">Max &Delta;</div>
                  <div class="dashHead">Volume</div>
                  <div class="dashHead">Vol &Delta;</div>
                  ${exerciseNames.map(name => {
                    const cur = currentStats[name] || {};
                    const prev = prevStats[name] || {};
                    const curMax = cur.maxWeight ?? null;
                    const prevMax = prev.maxWeight ?? null;
                    const curVol = Number.isFinite(cur.volume) ? cur.volume : null;
                    const prevVol = Number.isFinite(prev.volume) ? prev.volume : null;
                    const maxDelta = (curMax !== null && prevMax !== null) ? (curMax - prevMax) : null;
                    const volDelta = (curVol !== null && prevVol !== null) ? (curVol - prevVol) : null;
                    return `
                      <div class="dashCell">${escapeHtml(name)}</div>
                      <div class="dashCell">${formatNumber(curMax)}</div>
                      <div class="dashCell">${formatDelta(maxDelta)}</div>
                      <div class="dashCell">${formatNumber(curVol)}</div>
                      <div class="dashCell">${formatDelta(volDelta)}</div>
                    `;
                  }).join("")}
                </div>
              </div>
            </details>
          </div>
        </details>
      `;

      const weekSelect = $("#weekSelect");
      if(weekSelect){
        weekSelect.onchange = () => {
          state.viewWeekStart = weekSelect.value;
          save(state);
          render();
        };
      }
      renderTabs();
      return;
    }

    const mobilityHtml = day.mobility.map(m => {
      const checked = !!session.mobilityDone[m.name];
      return `
        <div class="checkbox">
          <input type="checkbox" ${checked ? "checked":""} data-mob="${escapeHtml(m.name)}">
          <div>
            <div class="t">${escapeHtml(m.name)}</div>
            <div class="d" style="color:var(--accent); font-weight:700; margin-bottom:2px">${escapeHtml(m.dose)}</div>
            <div class="d">${escapeHtml(m.cue)}</div>
          </div>
        </div>
      `;
    }).join("");

    const liftsHtml = day.lifts.map(lift => {
      const option = getLiftOption(session, day.id, lift);
      const arr = ensureLiftArray(session, lift, option);
      const prevData = getPrevLiftData(day.id, lift, option);
      const prevOption = prevData.option;
      const prevArr = prevData.sets || [];
      const prevWeekLabel = prevData.weekKey ? ` (week of ${prevData.weekKey})` : "";
      const suggestion = getOverloadSuggestion(lift, prevArr);

      let activeCue = lift.cue;
      if(lift.cues && option && lift.cues[option]) activeCue = lift.cues[option];

      const tableRows = arr.map((set, i) => {
        const idx = i;
        const prevSet = prevArr[idx] || null;
        const prevLabel = prevOption ? ` (${escapeHtml(prevOption)})` : "";
        const prevText = prevSet
          ? `Prev${prevLabel}${prevWeekLabel} set ${i+1}: reps ${escapeHtml(prevSet.reps || "‚Äî")}, weight ${escapeHtml(prevSet.weight || "‚Äî")}, RPE ${escapeHtml(prevSet.rpe || "‚Äî")}, ${prevSet.done ? "done" : "not done"}`
          : `Prev${prevLabel}${prevWeekLabel} set ${i+1}: no data`;
        return `
          <div class="setnum">Set ${i+1}</div>
          <div class="cell"><input inputmode="numeric" placeholder="${escapeHtml(lift.reps)}" value="${escapeHtml(set.reps)}" data-lift="${escapeHtml(lift.name)}" data-opt="${escapeHtml(option || "")}" data-field="reps" data-idx="${idx}"></div>
          <div class="cell"><input inputmode="decimal" placeholder="weight" value="${escapeHtml(set.weight)}" data-lift="${escapeHtml(lift.name)}" data-opt="${escapeHtml(option || "")}" data-field="weight" data-idx="${idx}"></div>
          <div class="cell"><input inputmode="decimal" placeholder="RPE 1‚Äì10" value="${escapeHtml(set.rpe)}" data-lift="${escapeHtml(lift.name)}" data-opt="${escapeHtml(option || "")}" data-field="rpe" data-idx="${idx}"></div>
          <div class="done"><input type="checkbox" ${set.done ? "checked":""} data-lift="${escapeHtml(lift.name)}" data-opt="${escapeHtml(option || "")}" data-field="done" data-idx="${idx}"></div>
          <div class="compareRow">${prevText}</div>
        `;
      }).join("");

      const optionToggle = lift.options ? `
        <div class="optionToggle" role="group" aria-label="Exercise option">
          ${lift.options.map(opt => `
            <button class="optBtn ${opt === option ? "active" : ""}" data-lift="${escapeHtml(lift.name)}" data-opt="${escapeHtml(opt)}" type="button">${escapeHtml(opt)}</button>
          `).join("")}
        </div>
      ` : "";

      const detailKey = liftDetailKey(day.id, lift);
      const isOpen = openLifts.has(detailKey);
      return `
        <details data-detail="${escapeHtml(detailKey)}" ${isOpen ? "open" : ""}>
          <summary>
            ${escapeHtml(lift.name)}
          </summary>
          <div class="details-body">
            <div class="small">
              <span class="pill">Sets <b>${lift.sets}</b></span>
              <span class="pill">Reps <b>${escapeHtml(lift.reps)}</b></span>
              <span class="pill">Rest <b>${escapeHtml(lift.rest)}</b></span>
              ${optionToggle}
              ${suggestion ? `<div class="suggestion">üéØ ${escapeHtml(suggestion)}</div>` : ""}
              <div class="hr"></div>
              <div><b>Coaching cue:</b> ${escapeHtml(activeCue)}</div>
            </div>

            <div class="hr"></div>
            <div class="row" style="justify-content:space-between; margin:8px 0 10px">
              <div class="small">
                Planned sets: <b>${lift.sets}</b>
                &nbsp;‚Ä¢&nbsp;
                Total sets: <b>${arr.length}</b>
              </div>
              <div class="row" style="gap:8px">
                <button class="btn" type="button"
                  data-addset="1"
                  data-lift="${escapeHtml(lift.name)}"
                  data-opt="${escapeHtml(option || "")}">
                  + Add set
                </button>
                <button class="btn" type="button"
                  data-rmset="1"
                  data-lift="${escapeHtml(lift.name)}"
                  data-opt="${escapeHtml(option || "")}"
                  ${arr.length <= lift.sets ? "disabled" : ""}>
                  ‚Äì Remove set
                </button>
                ${hasLiftData(prevArr) ? `
                <button class="btn" type="button"
                  data-copyprev="1"
                  data-lift="${escapeHtml(lift.name)}"
                  data-opt="${escapeHtml(option || "")}">
                  Copy Prev
                </button>` : ""}
              </div>
            </div>

            <div class="table">
              <div class="th">Set</div>
              <div class="th">Reps</div>
              <div class="th">Weight</div>
              <div class="th">RPE</div>
              <div class="th" style="text-align:center">Done</div>
              ${tableRows}
            </div>

            <div class="small" style="margin-top:10px">
              Execution: keep effort high but controlled (generally stop 1‚Äì2 reps before failure on most sets).
            </div>
          </div>
        </details>
      `;
    }).join("");

    app.innerHTML = `
      <div class="card stickyTop">
        <div class="ch">
          <h2>${escapeHtml(day.title)}</h2>
        </div>
        <div class="cb">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="small">Workout timer</div>
              <div class="time compact" id="workoutTime">${formatTime(timers.workout.elapsed)}</div>
            </div>
            <span class="badge" id="workoutStatus">${timers.workout.running ? "Running" : "Paused"}</span>
          </div>
          <div class="timerControls">
            <button class="btn good" id="workoutStartBtn">Start</button>
            <button class="btn" id="workoutPauseBtn">Pause</button>
            <button class="btn bad" id="workoutResetBtn">Reset</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cb">
          <details>
            <summary>Rest Time Duration (click to expand)</summary>
            <div class="details-body">
              <div class="row" style="justify-content:space-between">
                <div>
                  <div class="small">Rest timer setup</div>
                  <div class="time" id="restDurationLbl">${formatTime(timers.rest.duration)}</div>
                </div>
                <span class="badge">Set duration</span>
              </div>
              <div class="row" style="margin-top:6px">
                <input class="inputMini" id="restMin" inputmode="numeric" placeholder="min">
                <input class="inputMini" id="restSec" inputmode="numeric" placeholder="sec">
                <button class="btn" id="restSetBtn">Set</button>
              </div>
              <div class="small" style="margin-top:6px">Auto-starts when you mark a set done.</div>
            </div>
          </details>
        </div>
      </div>

      <div id="restOverlay" class="restOverlay hidden"></div>
      <div id="restPopup" class="restPopup hidden">
        <div class="row">
          <div>
            <div class="small">Rest timer</div>
            <div class="time" id="restPopupTime">${formatTime(timers.rest.remaining)}</div>
          </div>
          <span class="badge" id="restPopupStatus">${timers.rest.running ? "Running" : "Paused"}</span>
        </div>
        <div class="timerControls" style="margin-top:8px">
          <button class="btn" id="enableAudioBtn">Enable sound</button>
          <button class="btn" id="restMinusBtn">-15s</button>
          <button class="btn" id="restPlusBtn">+15s</button>
          <button class="btn" id="restPauseBtn">Pause</button>
          <button class="btn bad" id="restResetBtn">Reset</button>
          <button class="btn" id="restCloseBtn">Close</button>
        </div>
      </div>

      <!--
      <details class="card">
        <summary>
          Weekly Dashboard (click to expand)
          <span class="badge">Week of ${viewWeek}</span>
        </summary>
        <div class="details-body">
          <div class="row" style="margin-bottom:10px">
            <span class="small" style="min-width:110px">View week:</span>
            <select id="weekSelect" class="inputMini" style="width:auto; min-width:140px">
              ${allWeeks.length ? allWeeks.map(w => `
                <option value="${w}" ${w === viewWeek ? "selected":""}>${w}</option>
              `).join("") : `<option value="${viewWeek}" selected>${viewWeek}</option>`}
            </select>
            <span class="small">Dashboard only (workout view stays on current week).</span>
          </div>
          <div class="row">
            <span class="pill">Days <b>${weekSummary.completed}/5</b></span>
            <span class="pill">Sets <b>${weekSummary.doneSets}/${weekSummary.totalSets}</b></span>
            <span class="pill">Mobility <b>${weekSummary.mobDone}/${weekSummary.mobTotal}</b></span>
            <span class="pill">Conditioning <b>${weekSummary.condTotal} min</b></span>
            <span class="pill">Evaluation <b>${weekSummary.evaluation}</b></span>
          </div>
          <div class="row" style="margin-top:8px">
            <span class="small">Vs previous week:</span>
            ${prevWeekSummary ? `
              <span class="pill">Days <b>${weekSummary.completed - prevWeekSummary.completed >= 0 ? "+" : ""}${weekSummary.completed - prevWeekSummary.completed}</b></span>
              <span class="pill">Sets <b>${weekSummary.doneSets - prevWeekSummary.doneSets >= 0 ? "+" : ""}${weekSummary.doneSets - prevWeekSummary.doneSets}</b></span>
              <span class="pill">Mobility <b>${weekSummary.mobDone - prevWeekSummary.mobDone >= 0 ? "+" : ""}${weekSummary.mobDone - prevWeekSummary.mobDone}</b></span>
              <span class="pill">Conditioning <b>${weekSummary.condTotal - prevWeekSummary.condTotal >= 0 ? "+" : ""}${weekSummary.condTotal - prevWeekSummary.condTotal} min</b></span>
            ` : `<span class="pill">No previous week data</span>`}
          </div>
          <div class="dashTable">
            <div class="dashHead">Day</div>
            <div class="dashHead">Status</div>
            <div class="dashHead">Sets</div>
            <div class="dashHead">Mobility</div>
            <div class="dashHead">Conditioning</div>
            ${weekSummary.days.map(d => `
              <div class="dashCell">${escapeHtml(d.title)}</div>
              <div class="dashCell">${d.completed ? "Completed" : "In progress"}</div>
              <div class="dashCell">${d.doneSets}/${d.totalSets}</div>
              <div class="dashCell">${d.mobDone}/${d.mobTotal}</div>
              <div class="dashCell">${Math.round(d.cond)} min</div>
            `).join("")}
          </div>
          <details>
            <summary>Exercise comparison to previous week (click to expand)</summary>
            <div class="details-body">
              <div class="dashTableWide">
                <div class="dashHead">Exercise</div>
                <div class="dashHead">Max</div>
                <div class="dashHead">Max &Delta;</div>
                <div class="dashHead">Volume</div>
                <div class="dashHead">Vol &Delta;</div>
                ${exerciseNames.map(name => {
                  const cur = currentStats[name] || {};
                  const prev = prevStats[name] || {};
                  const curMax = cur.maxWeight ?? null;
                  const prevMax = prev.maxWeight ?? null;
                  const curVol = Number.isFinite(cur.volume) ? cur.volume : null;
                  const prevVol = Number.isFinite(prev.volume) ? prev.volume : null;
                  const maxDelta = (curMax !== null && prevMax !== null) ? (curMax - prevMax) : null;
                  const volDelta = (curVol !== null && prevVol !== null) ? (curVol - prevVol) : null;
                  return `
                    <div class="dashCell">${escapeHtml(name)}</div>
                    <div class="dashCell">${formatNumber(curMax)}</div>
                    <div class="dashCell">${formatDelta(maxDelta)}</div>
                    <div class="dashCell">${formatNumber(curVol)}</div>
                    <div class="dashCell">${formatDelta(volDelta)}</div>
                  `;
                }).join("")}
              </div>
            </div>
          </details>
        </div>
      </details>
      -->\n<div class="card">
        <div class="ch">
          <h2>Mobility Warm-up</h2>
          <span class="badge">Before lifting</span>
        </div>
        <div class="cb">${mobilityHtml}</div>
      </div>

      <div class="card">
        <div class="ch">
          <h2>Main Workout</h2>
          <span class="badge">${day.lifts.length} exercises</span>
        </div>
        <div class="cb">${liftsHtml}</div>
      </div>

      <div class="card">
        <div class="ch">
          <h2>${escapeHtml(day.conditioning.label)}</h2>
          <span class="badge">Conditioning</span>
        </div>
        <div class="cb">
          <div class="small">${escapeHtml(day.conditioning.rx)}</div>
          <div class="hr"></div>
          ${day.id === "d1" ? `
          <div class="row">
            <div style="flex:1 1 140px">
              <div class="small" style="margin-bottom:6px">Push-ups set 1 reps</div>
              <input id="pushupSet1" type="number" style="width:100%; padding:10px 10px; border-radius:12px; border:1px solid var(--line); background:var(--input-bg); color:var(--text);"
                     inputmode="numeric" min="0" step="1" placeholder="e.g., 22" value="${escapeHtml((session.conditioningPushups && session.conditioningPushups.set1) || "")}">
            </div>
            <div style="flex:1 1 140px">
              <div class="small" style="margin-bottom:6px">Push-ups set 2 reps</div>
              <input id="pushupSet2" type="number" style="width:100%; padding:10px 10px; border-radius:12px; border:1px solid var(--line); background:var(--input-bg); color:var(--text);"
                     inputmode="numeric" min="0" step="1" placeholder="e.g., 18" value="${escapeHtml((session.conditioningPushups && session.conditioningPushups.set2) || "")}">
            </div>
          </div>
          ` : `
          <div class="row">
            <div style="flex:1 1 220px">
              <div class="small" style="margin-bottom:6px">Conditioning minutes completed (optional)</div>
              <input id="condMin" type="number" style="width:100%; padding:10px 10px; border-radius:12px; border:1px solid var(--line); background:var(--input-bg); color:var(--text);"
                     inputmode="numeric" min="0" step="0.1" placeholder="e.g., 15" value="${escapeHtml(session.conditioningMinutes||"")}">
            </div>
          </div>
          `}
        </div>
      </div>

      <div class="card">
        <div class="ch">
          <h2>Session Notes</h2>
          <span class="badge">Log</span>
        </div>
        <div class="cb">
          <textarea id="sessionNotes" style="width:100%; height:80px; padding:10px; border-radius:12px; border:1px solid var(--line); background:var(--input-bg); color:var(--text); font-family:var(--sans); font-size:13px;" placeholder="How did it feel? Pain? Energy levels?">${escapeHtml(session.notes || "")}</textarea>
        </div>
      </div>

      <div class="card">
        <div class="ch">
          <h2>Day Complete</h2>
          <span class="badge">${session.dayLocked ? "Locked" : "Unlocked"}</span>
        </div>
        <div class="cb">
          <div class="small" style="margin-bottom:8px">Locks all inputs for this day.</div>
          <button class="btn good" id="dayCompleteBtn" data-allow-when-locked="1">
            ${session.dayLocked ? "Unlock Day" : "Mark Day Complete"}
          </button>
        </div>
      </div>
    `;

    // Wire events (mobility)
    app.querySelectorAll('input[type="checkbox"][data-mob]').forEach(cb => {
      cb.addEventListener("change", () => {
        session.mobilityDone[cb.getAttribute("data-mob")] = cb.checked;
        updateAutoComplete(session, day);
        save(state);
        renderTabs();
      });
    });

    // Wire events (lift inputs)
    app.querySelectorAll('input[data-lift]').forEach(inp => {
      const liftName = inp.getAttribute("data-lift");
      const liftOpt = inp.getAttribute("data-opt") || null;
      const field = inp.getAttribute("data-field");
      const idx = parseInt(inp.getAttribute("data-idx"), 10);

      inp.addEventListener("input", () => {
        const liftDef = day.lifts.find(x => x.name === liftName);
        const arr = ensureLiftArray(session, liftDef, liftOpt);
        arr[idx][field] = inp.value;
        save(state);
      });

        if(inp.type === "checkbox"){
          inp.addEventListener("change", () => {
            const liftDef = day.lifts.find(x => x.name === liftName);
            const arr = ensureLiftArray(session, liftDef, liftOpt);
            arr[idx][field] = inp.checked;
            updateAutoComplete(session, day);
            save(state);
            renderTabs();
            if(field === "done" && inp.checked){
              startRestTimer();
            }
          });
        }
    });

    app.querySelectorAll(".optBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const liftName = btn.getAttribute("data-lift");
        const opt = btn.getAttribute("data-opt");
        const liftDef = day.lifts.find(x => x.name === liftName);
        if(!liftDef || !opt) return;
        openLifts.add(liftDetailKey(day.id, liftDef));
        if(!session.liftOptions) session.liftOptions = {};
        const key = liftOptionKey(day.id, liftDef);
        session.liftOptions[key] = opt;
        save(state);
        render();
      });
    });

    app.querySelectorAll("details[data-detail]").forEach(el => {
      el.addEventListener("toggle", () => {
        const key = el.getAttribute("data-detail");
        if(!key) return;
        if(el.open){
          openLifts.add(key);
        }else{
          openLifts.delete(key);
        }
      });
    });

    // Add/Remove sets
    app.querySelectorAll("button[data-addset]").forEach(btn => {
      btn.addEventListener("click", () => {
        const liftName = btn.getAttribute("data-lift");
        const liftOpt = btn.getAttribute("data-opt") || null;
        const liftDef = day.lifts.find(x => x.name === liftName);
        if(!liftDef) return;

        const cur = getExtraSets(session, liftDef, liftOpt);
        setExtraSets(session, liftDef, liftOpt, cur + 1);

        openLifts.add(liftDetailKey(day.id, liftDef)); // keep open
        save(state);
        render();
      });
    });

    app.querySelectorAll("button[data-rmset]").forEach(btn => {
      btn.addEventListener("click", () => {
        const liftName = btn.getAttribute("data-lift");
        const liftOpt = btn.getAttribute("data-opt") || null;
        const liftDef = day.lifts.find(x => x.name === liftName);
        if(!liftDef) return;

        const cur = getExtraSets(session, liftDef, liftOpt);
        if(cur <= 0) return;
        setExtraSets(session, liftDef, liftOpt, cur - 1);

        openLifts.add(liftDetailKey(day.id, liftDef)); // keep open
        save(state);
        render();
      });
    });

    // Copy previous values
    app.querySelectorAll("button[data-copyprev]").forEach(btn => {
      btn.addEventListener("click", () => {
        const liftName = btn.getAttribute("data-lift");
        const liftOpt = btn.getAttribute("data-opt") || null;
        const liftDef = day.lifts.find(x => x.name === liftName);
        if(!liftDef) return;

        const prevData = getPrevLiftData(day.id, liftDef, liftOpt);
        if(!hasLiftData(prevData.sets)) return;

        let targetOpt = liftOpt || prevData.option || null;
        if(liftDef.options && targetOpt && !liftDef.options.includes(targetOpt)){
          targetOpt = liftDef.options[0];
        }

        if(liftDef.options && targetOpt){
          if(!session.liftOptions) session.liftOptions = {};
          const key = liftOptionKey(day.id, liftDef);
          session.liftOptions[key] = targetOpt;
        }

        const desiredExtra = Math.max(0, (prevData.sets || []).length - (liftDef.sets || 0));
        setExtraSets(session, liftDef, targetOpt, desiredExtra);
        const arr = ensureLiftArray(session, liftDef, targetOpt);

        for(let i=0; i<arr.length; i++){
          const prevSet = (prevData.sets || [])[i];
          arr[i].reps = prevSet ? (prevSet.reps || "") : "";
          arr[i].weight = prevSet ? (prevSet.weight || "") : "";
          arr[i].rpe = prevSet ? (prevSet.rpe || "") : "";
          arr[i].done = false;
        }

        save(state);
        render();
      });
    });

    // Session Notes
    $("#sessionNotes").addEventListener("input", (e) => {
      session.notes = e.target.value;
      save(state);
    });


    // Conditioning tracking
    const condMin = $("#condMin");
    if(condMin){
      condMin.addEventListener("input", () => {
        session.conditioningMinutes = condMin.value;
        save(state);
      });
    }
    const pushupSet1 = $("#pushupSet1");
    const pushupSet2 = $("#pushupSet2");
    if(pushupSet1 || pushupSet2){
      if(!session.conditioningPushups) session.conditioningPushups = {set1:"", set2:""};
      if(pushupSet1){
        pushupSet1.addEventListener("input", () => {
          session.conditioningPushups.set1 = pushupSet1.value;
          save(state);
        });
      }
      if(pushupSet2){
        pushupSet2.addEventListener("input", () => {
          session.conditioningPushups.set2 = pushupSet2.value;
          save(state);
        });
      }
    }

    const dayCompleteBtn = $("#dayCompleteBtn");
    if(dayCompleteBtn){
      dayCompleteBtn.addEventListener("click", () => {
        if(session.dayLocked){
          if(!confirm("Unlock this day and re-enable inputs?")) return;
          session.dayLocked = false;
        }else{
          session.dayLocked = true;
          session.completed = true;
          stopRestTimer();
          stopWorkoutTimer();
          persistTimers();
          hideRestPopup();
        }
        save(state);
        render();
      });
    }

    renderTabs();
    updateTimersUI();
    wireTimers();
    applyDayLock(app, session.dayLocked);
    if(timers.rest.running){
      showRestPopup();
    }else{
      hideRestPopup();
    }

    const weekSelect = $("#weekSelect");
    if(weekSelect){
      weekSelect.onchange = () => {
        state.viewWeekStart = weekSelect.value;
        save(state);
        render();
      };
    }
  }

  // Export / Reset
  $("#exportBtn").onclick = () => {
    const data = localStorage.getItem(KEY) || "{}";
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `workout-tracker-export-${isoDate()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  $("#importBtn").onclick = () => {
    $("#importFile").click();
  };

  $("#importFile").onchange = (e) => {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (ev) => {
      try{
        const json = JSON.parse(ev.target.result);
        if(!json.weekStart || !json.sessions) throw new Error("Invalid format");
        if(!confirm("This will overwrite your current data. Continue?")) return;
        localStorage.setItem(KEY, JSON.stringify(json));
        location.reload();
      }catch(err){
        alert("Error importing file: " + err.message);
      }
    };
    r.readAsText(f);
  };

  $("#themeToggle").onclick = () => {
    state.theme = state.theme === "light" ? "dark" : "light";
    if(state.theme === "light") document.body.classList.add("light");
    else document.body.classList.remove("light");
    save(state);
  };

  const menuToggle = $("#menuToggle");
  const menuPopup = $("#menuPopup");
  const menuOverlay = $("#menuOverlay");
  if(menuToggle){
    menuToggle.onclick = () => {
      menuPopup.classList.toggle("show");
      menuOverlay.classList.toggle("show");
    };
    menuOverlay.onclick = () => {
      menuPopup.classList.remove("show");
      menuOverlay.classList.remove("show");
    };
    // Close menu when clicking an item
    menuPopup.querySelectorAll(".menuItem").forEach(b => b.addEventListener("click", () => menuOverlay.click()));
  }

  $("#resetBtn").onclick = () => {
    if(!confirm("Reset all saved data on this device?")) return;
    localStorage.removeItem(KEY);
    state = defaultState();
    save(state);
    render();
  };

  $("#dashboardBtn").onclick = () => {
    state.activeDayId = "dashboard";
    save(state);
    render();
  };

  // Init
  ensureWeek();
  save(state);
  scheduleWeeklyRollover();
  render();

})();
</script>
</body>
</html>
